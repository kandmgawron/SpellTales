import React, { useState, useEffect } from 'react';
import { Text, View, TextInput, TouchableOpacity, Alert, ScrollView, ImageBackground, Platform } from 'react-native';
import { useFonts } from 'expo-font';
import { Nunito_600SemiBold } from '@expo-google-fonts/nunito';
import { createGlobalStyles } from './styles/GlobalStyles';
import { CONFIG } from './config';

export default function AuthScreen({ onAuthSuccess, onGuestMode, darkMode = true, initialMode = 'welcome' }) {
  let [fontsLoaded] = useFonts({
    Nunito_600SemiBold,
  });

  const globalStyles = createGlobalStyles(darkMode);
  const [mode, setMode] = useState(initialMode);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [verificationCode, setVerificationCode] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [biometricAvailable, setBiometricAvailable] = useState(false);
  const [biometricEnabled, setBiometricEnabled] = useState(false);

  useEffect(() => {
    checkBiometrics();
  }, []);

  const checkBiometrics = async () => {
    const available = await checkBiometricSupport();
    const enabled = await isBiometricEnabled();
    setBiometricAvailable(available);
    setBiometricEnabled(enabled);
  };

  const handleSignIn = async () => {
    if (!email || !password) {
      Alert.alert('Error', 'Please fill in all fields');
      return;
    }
    
    setLoading(true);
    try {
      const response = await fetch('https://rnbcv6rsb7.execute-api.eu-west-2.amazonaws.com/prod/auth', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'signIn',
          email: email,
          password: password
        })
      });

      const result = await response.json();
      
      if (result.success) {
        // Offer to save credentials for biometric login (mobile only)
        if (Platform.OS !== 'web' && biometricAvailable && !biometricEnabled) {
          Alert.alert(
            'Enable Biometric Login?',
            'Would you like to use Face ID/Touch ID for faster login next time?',
            [
              { text: 'No Thanks', style: 'cancel' },
              { 
                text: 'Enable', 
                onPress: async () => {
                  await saveBiometricCredentials(email, password);
                  setBiometricEnabled(true);
                }
              }
            ]
          );
        }
        onAuthSuccess(result.AuthenticationResult, email, false);
      } else {
        Alert.alert('Error', result.error || 'Invalid email or password');
      }
    } catch (error) {
      Alert.alert('Error', 'Login failed. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const handleBiometricLogin = async () => {
    setLoading(true);
    try {
      const authenticated = await authenticateWithBiometrics('Sign in to SpellTales');
      
      if (authenticated) {
        const credentials = await getBiometricCredentials();
        if (credentials) {
          // Create a mock authentication result for biometric login
          const mockAuthResult = {
            AccessToken: 'biometric-token-' + Date.now(),
            IdToken: 'biometric-id-token-' + Date.now(),
            RefreshToken: 'biometric-refresh-token-' + Date.now(),
          };
          onAuthSuccess(mockAuthResult, credentials.email, false);
        }
      }
    } catch (error) {
      Alert.alert('Error', 'Biometric authentication failed');
    } finally {
      setLoading(false);
    }
  };

  const handleSignUp = async () => {
    if (!email || !password) {
      Alert.alert('Error', 'Please fill in all fields');
      return;
    }
    
    // Password validation
    if (password.length < 8) {
      Alert.alert('Password Requirements', 'Password must be at least 8 characters long');
      return;
    }
    
    if (!/[A-Z]/.test(password)) {
      Alert.alert('Password Requirements', 'Password must contain at least one uppercase letter');
      return;
    }
    
    if (!/[a-z]/.test(password)) {
      Alert.alert('Password Requirements', 'Password must contain at least one lowercase letter');
      return;
    }
    
    if (!/[0-9]/.test(password)) {
      Alert.alert('Password Requirements', 'Password must contain at least one number');
      return;
    }
    
    setLoading(true);
    try {
      const response = await fetch('https://rnbcv6rsb7.execute-api.eu-west-2.amazonaws.com/prod/auth', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'signUp',
          email: email,
          password: password
        })
      });

      const result = await response.json();
      
      if (result.success) {
        Alert.alert(
          'Success', 
          'Account created! Please check your email for a verification code.',
          [{ text: 'OK', onPress: () => setMode('verify') }]
        );
      } else {
        Alert.alert('Error', result.error || 'Failed to create account');
      }
    } catch (error) {
      Alert.alert('Error', 'Sign up failed. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const confirmSignUp = async (email, verificationCode) => {
    const response = await fetch(`https://cognito-idp.${CONFIG.COGNITO_REGION}.amazonaws.com/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-amz-json-1.1',
        'X-Amz-Target': 'AWSCognitoIdentityProviderService.ConfirmSignUp'
      },
      body: JSON.stringify({
        ClientId: CONFIG.COGNITO_CLIENT_ID,
        Username: email,
        ConfirmationCode: verificationCode
      })
    });

    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.message || 'Verification failed');
    }
  };

  const handleVerifyCode = async () => {
    if (!verificationCode) {
      Alert.alert('Error', 'Please enter verification code');
      return;
    }
    
    setLoading(true);
    try {
      await confirmSignUp(email, verificationCode);
      Alert.alert(
        'Success', 
        'Email verified! Check out our premium features.',
        [{ text: 'OK', onPress: () => setMode('subscription') }]
      );
    } catch (error) {
      Alert.alert('Error', error.message || 'Invalid verification code');
    } finally {
      setLoading(false);
    }
  };

  const handleForgotPassword = async () => {
    if (!email) {
      Alert.alert('Error', 'Please enter your email address');
      return;
    }
    
    setLoading(true);
    try {
      const response = await fetch(`https://cognito-idp.${CONFIG.COGNITO_REGION}.amazonaws.com/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-amz-json-1.1',
          'X-Amz-Target': 'AWSCognitoIdentityProviderService.ForgotPassword'
        },
        body: JSON.stringify({
          ClientId: CONFIG.COGNITO_CLIENT_ID,
          Username: email
        })
      });

      const data = await response.json();
      
      if (response.ok) {
        Alert.alert(
          'Success', 
          'Password reset code sent to your email.',
          [{ text: 'OK', onPress: () => setMode('resetPassword') }]
        );
      } else {
        Alert.alert('Error', data.message || 'Failed to send reset code');
      }
    } catch (error) {
      Alert.alert('Error', 'Failed to send reset code. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const handleResetPassword = async () => {
    if (!verificationCode || !newPassword) {
      Alert.alert('Error', 'Please fill in all fields');
      return;
    }
    
    if (newPassword.length < 8) {
      Alert.alert('Error', 'Password must be at least 8 characters');
      return;
    }
    
    setLoading(true);
    try {
      const response = await fetch(`https://cognito-idp.${CONFIG.COGNITO_REGION}.amazonaws.com/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-amz-json-1.1',
          'X-Amz-Target': 'AWSCognitoIdentityProviderService.ConfirmForgotPassword'
        },
        body: JSON.stringify({
          ClientId: CONFIG.COGNITO_CLIENT_ID,
          Username: email,
          ConfirmationCode: verificationCode,
          Password: newPassword
        })
      });

      const data = await response.json();
      
      if (response.ok) {
        Alert.alert(
          'Success', 
          'Password reset successfully! You can now sign in.',
          [{ text: 'OK', onPress: () => setMode('signin') }]
        );
      } else {
        Alert.alert('Error', data.message || 'Failed to reset password');
      }
    } catch (error) {
      Alert.alert('Error', 'Failed to reset password. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const renderWelcome = () => (
    <View style={globalStyles.welcomeContainer}>
      <Text style={[globalStyles.authTitle, fontsLoaded && { fontFamily: 'Nunito_600SemiBold' }]}>
        SpellTales
      </Text>
      <Text style={globalStyles.authSubtitle}>Magical Stories for Learning</Text>
      
      <View style={[globalStyles.section, {width: '100%'}]}>
        <Text style={globalStyles.descriptionText}>âœ¨ Personalised and custom bedtime stories tailored to your child's age</Text>
        <Text style={globalStyles.descriptionText}>ğŸ“š Integrate spelling words into engaging adventures</Text>
        <Text style={globalStyles.descriptionText}>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Create profiles for different children with age-appropriate content</Text>
        <Text style={globalStyles.descriptionText}>ğŸ’¾ Save and replay your favourite stories anytime</Text>
      
        <TouchableOpacity 
          style={globalStyles.primaryButton}
          onPress={() => setMode('signin')}
        >
          <Text style={globalStyles.buttonText}>Log In</Text>
        </TouchableOpacity>
        
        <TouchableOpacity 
          style={globalStyles.outlineButton}
          onPress={() => setMode('signup')}
        >
          <Text style={globalStyles.outlineButtonText}>Sign Up</Text>
        </TouchableOpacity>
        
        <TouchableOpacity 
          style={globalStyles.linkButton}
          onPress={onGuestMode}
        >
          <Text style={globalStyles.linkButtonText}>Continue as guest</Text>
        </TouchableOpacity>
      </View>
    </View>
  );

  const renderSignIn = () => (
    <View style={globalStyles.authFormContainer}>
      <View style={{width: '100%', alignItems: 'flex-start', marginBottom: 20}}>
        <TouchableOpacity style={globalStyles.homeButton} onPress={() => setMode('welcome')}>
          <Text style={globalStyles.homeButtonText}>ğŸ  Home</Text>
        </TouchableOpacity>
      </View>
      
      <Text style={[globalStyles.authTitle, fontsLoaded && { fontFamily: 'Nunito_600SemiBold' }]}>
        Welcome Back
      </Text>
      
      <View style={[globalStyles.section, {width: '100%'}]}>
        <TextInput
          style={globalStyles.textInput}
          value={email}
          onChangeText={setEmail}
          placeholder="Email"
          placeholderTextColor="#888"
          keyboardType="email-address"
          autoCapitalize="none"
        />
        
        <TextInput
          style={globalStyles.textInput}
          value={password}
          onChangeText={setPassword}
          placeholder="Password"
          placeholderTextColor="#888"
          secureTextEntry
          autoCapitalize="none"
        />
        
        <TouchableOpacity 
          style={[globalStyles.primaryButton, loading && globalStyles.buttonDisabled]}
          onPress={handleSignIn}
          disabled={loading}
        >
          <Text style={globalStyles.buttonText}>
            {loading ? 'Signing In...' : 'Log In'}
          </Text>
        </TouchableOpacity>
        
        {biometricAvailable && biometricEnabled && (
          <TouchableOpacity 
            style={[globalStyles.outlineButton, loading && globalStyles.buttonDisabled]}
            onPress={handleBiometricLogin}
            disabled={loading}
          >
            <Text style={globalStyles.outlineButtonText}>ğŸ” Use Face ID / Touch ID</Text>
          </TouchableOpacity>
        )}
        
        <TouchableOpacity 
          style={globalStyles.outlineButton}
          onPress={handleForgotPassword}
        >
          <Text style={globalStyles.outlineButtonText}>Forgot Password?</Text>
        </TouchableOpacity>
      </View>
    </View>
  );

  const renderSignUp = () => (
    <View style={globalStyles.authFormContainer}>
      <View style={{width: '100%', alignItems: 'flex-start', marginBottom: 20}}>
        <TouchableOpacity style={globalStyles.homeButton} onPress={() => setMode('welcome')}>
          <Text style={globalStyles.homeButtonText}>ğŸ  Home</Text>
        </TouchableOpacity>
      </View>
      
      <Text style={[globalStyles.authTitle, fontsLoaded && { fontFamily: 'Nunito_600SemiBold' }]}>
        Create Account
      </Text>
      
      <View style={[globalStyles.section, {width: '100%'}]}>
        <TextInput
          style={globalStyles.textInput}
          value={email}
          onChangeText={setEmail}
          placeholder="Email"
          placeholderTextColor="#888"
          keyboardType="email-address"
          autoCapitalize="none"
        />
        
        <TextInput
          style={globalStyles.textInput}
          value={password}
          onChangeText={setPassword}
          placeholder="Password"
          placeholderTextColor="#888"
          secureTextEntry
          autoCapitalize="none"
        />
        
        <Text style={{color: '#888', fontSize: 12, marginBottom: 15, marginTop: -10}}>
          Password must be at least 8 characters with uppercase, lowercase, and number
        </Text>
        
        <TouchableOpacity 
          style={[globalStyles.primaryButton, loading && globalStyles.buttonDisabled]}
          onPress={handleSignUp}
          disabled={loading}
        >
          <Text style={globalStyles.buttonText}>
            {loading ? 'Creating Account...' : 'Sign Up'}
          </Text>
        </TouchableOpacity>
      </View>
    </View>
  );

  const renderVerify = () => (
    <View style={globalStyles.container}>
      <View style={globalStyles.authFormContainer}>
        <View style={{width: '100%', alignItems: 'flex-start', marginBottom: 20}}>
          <TouchableOpacity style={globalStyles.homeButton} onPress={() => setMode('welcome')}>
            <Text style={globalStyles.homeButtonText}>ğŸ  Home</Text>
          </TouchableOpacity>
        </View>
        
        <Text style={globalStyles.heading}>
          Verify Email
        </Text>
        
        <Text style={globalStyles.welcomeText}>
          Enter the verification code sent to {email}
        </Text>
        
        <TextInput
          style={globalStyles.authInput}
          value={verificationCode}
          onChangeText={setVerificationCode}
          placeholder="Verification Code"
          placeholderTextColor="#888"
          keyboardType="number-pad"
          autoCapitalize="none"
        />
        
        <TouchableOpacity 
          style={[globalStyles.primaryButton, loading && globalStyles.buttonDisabled]}
          onPress={handleVerifyCode}
          disabled={loading}
        >
          <Text style={globalStyles.buttonText}>
            {loading ? 'Verifying...' : 'Verify Email'}
          </Text>
        </TouchableOpacity>
      </View>
    </View>
  );

  const renderResetPassword = () => (
    <View style={globalStyles.authFormContainer}>
      <View style={{width: '100%', alignItems: 'flex-start', marginBottom: 20}}>
        <TouchableOpacity style={globalStyles.homeButton} onPress={() => setMode('welcome')}>
          <Text style={globalStyles.homeButtonText}>ğŸ  Home</Text>
        </TouchableOpacity>
      </View>
      
      <Text style={globalStyles.heading}>
        Reset Password
      </Text>
      
      <Text style={globalStyles.welcomeText}>
        Enter the code sent to {email} and your new password
      </Text>
      
      <TextInput
        style={globalStyles.authInput}
        value={verificationCode}
        onChangeText={setVerificationCode}
        placeholder="Verification Code"
        placeholderTextColor="#888"
        keyboardType="number-pad"
        autoCapitalize="none"
      />
      
      <TextInput
        style={globalStyles.authInput}
        value={newPassword}
        onChangeText={setNewPassword}
        placeholder="New Password"
        placeholderTextColor="#888"
        secureTextEntry
        autoCapitalize="none"
      />
      
      <TouchableOpacity 
        style={[globalStyles.primaryButton, loading && globalStyles.buttonDisabled]}
        onPress={handleResetPassword}
        disabled={loading}
      >
        <Text style={globalStyles.buttonText}>
          {loading ? 'Resetting...' : 'Reset Password'}
        </Text>
      </TouchableOpacity>
    </View>
  );

  const renderSubscription = () => (
    <View style={globalStyles.authFormContainer}>
      <Text style={[globalStyles.authTitle, fontsLoaded && { fontFamily: 'Nunito_600SemiBold' }]}>
        Welcome to SpellTales!
      </Text>
      
      <View style={[globalStyles.section, {width: '100%'}]}>
        <Text style={globalStyles.cardTitle}>ğŸŒŸ Go Premium - Â£2.99/month</Text>
        <Text style={globalStyles.descriptionText}>âœ¨ Unlimited story generation</Text>
        <Text style={globalStyles.descriptionText}>ğŸš« No advertisements</Text>
        <Text style={globalStyles.descriptionText}>ğŸ‘¨ğŸ‘©ğŸ‘§ğŸ‘¦ Multiple child profiles</Text>
        <Text style={globalStyles.descriptionText}>ğŸ’¾ Save unlimited stories</Text>
        
        <TouchableOpacity 
          style={globalStyles.primaryButton}
          onPress={() => setMode('signin')}
        >
          <Text style={globalStyles.buttonText}>Continue to Sign In</Text>
        </TouchableOpacity>
        
        <Text style={globalStyles.welcomeText}>
          You can subscribe anytime from the app menu
        </Text>
      </View>
    </View>
  );

  return (
    <ImageBackground 
      source={require('./assets/splash_logo.png')} 
      style={globalStyles.authBackgroundImage}
      imageStyle={globalStyles.backgroundImageStyle}
    >
      <ScrollView 
        style={globalStyles.screenContainer}
        keyboardShouldPersistTaps="handled"
      >
        <View style={globalStyles.authInnerContainer}>
          {mode === 'welcome' && renderWelcome()}
          {mode === 'signin' && renderSignIn()}
          {mode === 'signup' && renderSignUp()}
          {mode === 'verify' && renderVerify()}
          {mode === 'subscription' && renderSubscription()}
          {mode === 'resetPassword' && renderResetPassword()}
        </View>
      </ScrollView>
    </ImageBackground>
  );
}

